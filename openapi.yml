openapi: '3.0.2'
info:
  title: Grader Server Extension API
  version: '0.1'
servers:
  - url: https://api.server.test/v1

###### Tags of API endpoints
tags:
- name: "Lectures"
  description: "Available lectures"
- name: "Assignments"
  description: Assignments of a lecture
- name: "Submissions"
  description: View submissions of an assignment
- name: "Validation"
  description: Validation of exercises in an assignment
- name: "Grading"
  description: Manage the grading and feedback of assignments (Instructor)

paths:
  /lectures:
    post:
      security:
        - hub_auth:
          - instructor
      summary: Create new lecture
      tags:
      - "Lectures"
      requestBody:
        description: The initial state of an assignment. Every field will be empty except `due_date` and `name`.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Lecture'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Lecture"
        403:
          description: Unautorized
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"  
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: "Return all lectures that are available to the user"
      tags:
      - "Lectures"
      parameters:
        - name: semester
          in: query
          description: The semester for which to fetch lectures
          required: false
          example: "SS21"
          schema:
            type: string
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Lecture"
        403:
          description: Unautorized
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  
  /lectures/{lect_id}:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: Return the lecture with specified id
      tags:
      - "Lectures"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Lecture"
        403:
          description: Unautorized
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage" 

  /lectures/{lect_id}/assignments:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: "Return the assignments of a specific lecture"
      tags:
        - "Assignments"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Assignment"
        403:
          description: Unautorized
        404:
          description: Lecture id not found.
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
    post:
      security:
        - hub_auth:
          - instructor
          - tutor
      summary: Request creation of an assignment
      tags:
      - Assignments
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      requestBody:
        description: The initial state of an assignment. Every field will be empty except `due_date` and `name`.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Assignment'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Assignment"
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found.
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  /lectures/{lect_id}/assignments/{a_id}:
    put:
      security:
        - hub_auth:
          - instructor
          - tutor
      summary: Update an existing assignment (also handles release)
      tags:
      - Assignments
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      requestBody:
        description: Updates all the non-empty fields.
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/Assignment'
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Assignment"
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found.
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: "Request the assignment to be fetched"
      tags: 
      - "Assignments"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      - name: instuctor_version # TODO: Take care of auth!!! Maybe different path?
        in: query
        description: Fetch the instructor version of the assignment
        required: false
        example: false
        schema:
          type: boolean
          default: false
      - name: metadata_only
        in: query
        description: Only return the assignment information and don't fetch it
        required: false
        example: false
        schema:
          type: boolean
          default: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Assignment"
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
    
  /lectures/{lect_id}/assignments/{a_id}/submissions:
    post:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: "Request assignment to be submitted"
      tags:
        - "Submissions"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      responses:
        200:
          description: OK
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found.
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: Return the submissions of an assignment
      tags:
        - "Submissions"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      - name: latest
        in: query
        description: Only return the latest submission
        required: false
        schema:
          type: boolean
          default: false
        # allowEmptyValue: true
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/Submission"
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  /lectures/{lect_id}/assignments/{a_id}/feedback:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: Return the feedback of an assignment
      tags:
        - "Submissions"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Feedback"
        403:
          description: Unautorized
        404:
          description: Lecture id or assignment id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  /lectures/{lect_id}/assignments/{a_id}/validate/{ex_id}:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: "Requests the exercise in an assignment to be validated"
      tags:
      - "Validation"
      parameters:
      - name: lect_id
        in: path
        description: ID of the lecture
        required: true
        example: 1
        schema:
          type: integer
          format: int64
      - name: a_id
        in: path
        description: ID of the assignment in the lecture
        required: true
        example: 2
        schema:
          type: integer
          format: int64
      - name: ex_id
        in: path
        description: ID of the exercise in the assignment
        required: true
        example: 0
        schema:
          type: integer
          format: int64
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                $ref: "#/components/schemas/ValidationResult"
        403:
          description: Unautorized
        404:
          description: Lecture id, assignment id or exercise id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  
    
  /lectures/{lect_id}/grading/:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
      summary: Return all student submissions of a lecture
      tags:
      - Grading
      parameters:
        - name: lect_id
          in: path
          description: ID of the lecture
          required: true
          example: 1
          schema:
            type: integer
            format: int64
        - name: metadata_only
          in: query
          description: Only return the metadata information of the submissions
          required: false
          example: false
          schema:
            type: boolean
            default: false
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "object"
                properties:
                  n_submissions:
                    type: integer
                    format: int64
                    example: 42
                  data:
                    type: array
                    items:
                      type: object
                      properties:
                        student:
                          $ref: "#/components/schemas/User"
                        submissions:
                          type: "array"
                          items:
                            $ref: "#/components/schemas/Submission"
        403:
          description: Unautorized
        404:
          description: Lecture id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
  /lectures/{lect_id}/grading/{student_id}:
    get:
      security:
        - hub_auth:
          - instructor
          - tutor
      summary: Returns all submissions of a student in a lecture
      tags:
      - Grading
      parameters:
        - name: lect_id
          in: path
          description: ID of the lecture
          required: true
          example: 1
          schema:
            type: integer
            format: int64
        - name: student_id
          in: path
          description: ID of the student that is enroled in the lecture
          required: true
          example: "12345678"
          schema:
            type: "string"
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "object"
                properties:
                  n_submissions:
                    type: integer
                    format: int64
                    example: 3
                  data:
                    properties:
                      student:
                        $ref: "#/components/schemas/User"
                      submissions:
                        type: "array"
                        items:
                          $ref: "#/components/schemas/Submission"
        403:
          description: Unautorized
        404:
          description: Lecture id or student id not found
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"

  /lectures/{lect_id}/grading/{student_id}/autograde:
    put:
      security:
        - hub_auth:
          - instructor
          - tutor
          - student
      summary: Request the latest submission to be autograded
      tags:
      - Grading
      parameters:
        - name: lect_id
          in: path
          description: ID of the lecture
          required: true
          example: 1
          schema:
            type: integer
            format: int64
        - name: student_id
          in: path
          description: ID of the student that is enroled in the lecture
          required: true
          example: "12345678"
          schema:
            type: "string"
        - name: submission_id
          in: query
          description: Specify the the submission that should be autograded instead of latest
          required: false
          example: 2
          schema:
            type: integer
            format: int64
      responses:
        200:
          description: OK
          content:
            application/json:
              schema:
                type: "array"
                items:
                  $ref: "#/components/schemas/Assignment"
        403:
          description: Unautorized
        404:
          description: Lecture id not found.
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"
        500:
          description: Internal server error
          content: 
            application/json:
              schema:
                $ref: "#/components/schemas/ErrorMessage"


###### Data type definitions
components:
  schemas:
    User:
      type: "object"
      properties:
        id: 
          type: "string" # tuwel id
          example: "12345678"
        name:
          type: "string"
          example: "Baz Bar"
    Lecture:
      type: "object"
      properties:
        id:
          type: "integer"
          format: "int64"
        name:
          type: "string"
          example: "Informationsvisualisierung"
        code:
          type: "string"
          example: "ivs21"
        complete:
          type: "boolean"
          default: false
        semester:
          type: "string"
          example: "SS21"
    Assignment:
      type: "object"
      properties:
        id:
          type: "integer"
          format: "int64"
        name:
          type: "string"
          example: "assignment_1"
        exercises:
          type: "array"
          items:
            $ref: "#/components/schemas/Exercise"
        files:
          type: "array"
          items:
            $ref: "#/components/schemas/File"
        due_date:
          type: "string"
          format: "date-time"
          example: "2021-07-21T23:55:00Z"
        path:
          type: "string"
          example: "~/assignment_1/"
        last_submitted:
          nullable: true
          type: "string"
          format: "date-time"
          example: "2021-07-21T11:53:07Z"
        status:
          type: string
          enum:
            - created # another state of an assignment (instructor only)
            - released
            - fetched
            - submitted
            - complete # final state -> final grade is calculated
    Exercise:
      type: "object"
      properties:
        id:
          type: "integer"
          format: "int64"
        a_id:
          type: "integer"
          format: "int64"
        name:
          type: string
          example: "exercise_1.ipynb"
        ex_type:
          type: string
          enum:
          - nbgrader # TODO: add more exercise types
        points:
          type: number
          format: float
    Submission:
      type: "object"
      properties:
        id:
          type: "integer"
          format: "int64"
        submitted_at:
          type: "string"
          format: "date-time"
          example: "2021-07-21T11:53:07Z"
        status:
          type: string
          enum:
            - not_graded
            - automatically_graded
            - manually_graded
    Feedback:
      type: "object"
      properties:
        id:
          type: "integer"
          format: "int64"
        submission_id:
          type: "integer"
          format: "int64"
        path:
          type: "string"
          example: "~/assignment_1/feedback/..."
    ValidationResult:
      type: "object"
      properties:
        status:
          type: string
          enum:
            - passed
            - failed
        # TODO: send failed cells and python output
        validation_errors:
          type: array
          items:
            type: object
            properties:
              error_line:
                type: string
                example: "assert(id(2)==2)"
              error_output:
                type: string
                example: "NotImplementedError at line ..."
    GradingResult:
      type: "object"
      properties:
        id:
          type: integer
          format: int64
        status:
          type: string
          enum:
          - needs_auto_grading
          - needs_manual_grading
          - completed
        score:
          type: number
          format: float
    ManualGradingContent:
      type: object
      properties: # TODO: use in api
        id:
          type: integer
          format: int64
        feedback_cells:
          type: array
          items:
            type: object
            properties:
              cell_id:
                type: integer
                format: int64
                example: 0
              feedback:
                type: string
    File:
      type: object
      properties:
        name:
          type: string
          example: "dataset.csv"
    ErrorMessage:
      type: "object"
      properties:
        msg:
          type: "string"
          example: "Some very detailed error message."

  securitySchemes:
    hub_auth:
      type: oauth2
      flows:
        implicit:
          authorizationUrl: http://auth.hub.something.tuwien.ac.at
          scopes:
            instructor: instructor of a lecture
            tutuor: tutor of a lecture
            student: student of a lecture
    api_key:
      type: apiKey
      name: api_key
      in: header